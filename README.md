# 🤖 麦麦自主规划插件

让麦麦拥有自己的生活日程，每天自动生成个性化的日常活动安排。

---

## 📝 功能简介

这个插件让麦麦能够：
- 🎯 自动生成每日生活日程（起床、吃饭、学习、娱乐等）
- 🎨 使用麦麦的人格和说话风格生成日程描述
- 🔄 每天自动更新日程，保持新鲜感
- 📅 通过命令查看和管理日程

---

## ✨ 核心特性

### 1. **个性化日程生成**
- 使用 LLM 根据麦麦的人格特质生成日程
- 日程描述符合麦麦的贴吧/知乎/微博风格
- 每天生成不同的内容（基于日期和随机人格状态）

### 2. **自动日程管理**
- 每天自动检查并生成新日程
- 自动删除过期的旧日程
- 保留30天历史记录

### 3. **日程自动提及**（核心功能）
- **日程会自动注入到麦麦的回复中**
- 麦麦会在对话中自然提到当前在做什么
- 例如："这会儿正吃早饭（随便啃个面包）" "等下要去上课"
- 配合人格系统，让回复更有生活感

---

## 🚀 快速开始

### 第一次使用

1. **生成日程**
   ```
   对麦麦说："帮我生成今天的每日计划"
   ```

2. **查看日程**
   ```
   /plan list
   ```

3. **等待自动生成**
   - 插件会在每天早上6点后自动生成当天日程
   - 无需手动操作

---

## 🎮 命令使用

| 命令 | 说明 | 示例 |
|------|------|------|
| `/plan status` | 查看简洁日程 | 显示时间段和活动 |
| `/plan list` | 查看详细日程 | 显示完整描述 |
| `/plan delete <序号>` | 删除指定日程 | `/plan delete 3` |
| `/plan help` | 查看帮助 | 显示所有命令 |

### 示例

**查看简洁日程：**
```
/plan status

📅 今日日程

07:00-08:00 🏠 起床
08:00-09:00 🍽️ 早饭
10:00-11:00 📚 看番
...
```

**查看详细日程：**
```
/plan list

📅 今日日程详情

  ⏰ 07:00-08:00  起床          周末多睡会儿，自然醒
  ⏰ 08:00-09:00  早饭          随便啃个面包，喝点牛奶
  ⏰ 10:00-11:00  看番          补下新番，顺便刷下贴吧
  ...
```

---

## ⚙️ 配置说明

配置文件：`config.toml`

### 基础配置

```toml
[plugin]
enabled = true  # 是否启用插件

[autonomous_planning]
interval = 3600  # 检查间隔（秒），1小时检查一次
max_actions_per_cycle = 0  # 设置为0表示只生成日程但不自动执行
```

### 日程自动生成

```toml
[autonomous_planning.auto_schedule]
check_interval = 3600  # 检查间隔（秒）

# 是否自动生成每日计划
auto_generate_daily = true

# 每日计划触发时间（每天6点后自动生成）
daily_trigger_time = "06:00"

# 自动清理旧目标（保留30天）
cleanup_old_goals_days = 30
```

### 日程注入配置（重要）

```toml
[autonomous_planning.schedule]
# 是否自动注入日程到回复的prompt
# true: 麦麦会在回复时自然提到当前活动（推荐）
# false: 不注入日程信息
inject_schedule = true
```

**说明**：
- 启用后，麦麦会在回复时自然提到当前正在做什么
- 例如：用户问"在干嘛"，麦麦会说"这会儿正吃午饭呢"
- 配合日程生成使用效果最佳

### 用户偏好设置

```toml
[autonomous_planning.schedule.preferences]
# 作息时间
wake_up_time = "07:30"
sleep_time = "23:30"

# 三餐时间
breakfast_time = "08:00"
lunch_time = "12:00"
dinner_time = "18:00"

# 学习相关
has_classes = true
class_time_morning = "09:00"
class_time_afternoon = "14:00"
study_time = "21:00"

# 娱乐爱好
entertainment_time = "19:00"
favorite_activities = ["刷贴吧", "看动漫", "玩游戏"]

# 兴趣学习
learning_topics = ["Python编程", "游戏开发", "动漫文化"]

# 社交和运动
social_active = true
exercise_occasionally = true
```

**修改方法：**
1. 编辑 `config.toml` 文件
2. 修改对应的时间或活动
3. 重启麦麦生效

---

## 📂 文件结构

```
autonomous_planning_plugin/
├── README.md              # 本文档
├── config.toml            # 配置文件
├── plugin.py              # 插件主文件
├── planner/               # 核心模块
│   ├── goal_manager.py           # 目标管理
│   ├── schedule_generator.py     # 日程生成（LLM）
│   └── auto_schedule_manager.py  # 自动调度
└── data/                  # 数据目录
    ├── goals.json                # 当前日程数据
    └── schedule_history.json     # 历史记录
```

---

## 🎯 工作原理

### 日程生成流程

```
1. 触发生成（手动/自动）
   ↓
2. 检查是否需要生成
   - 没有日程？→ 生成
   - 日程不是今天的？→ 删除旧的，生成新的
   - 已有今天的日程？→ 跳过
   ↓
3. 调用 LLM 生成日程
   - 读取麦麦的人格配置
   - 读取用户偏好设置
   - 根据当前日期生成个性化日程
   ↓
4. 批量保存日程
   - 10个活动只写入磁盘1次（性能优化）
   ↓
5. 注入到感知系统
   - 麦麦回复时会自然提到当前活动
```

### 自动检查机制

```
每小时检查一次
   ↓
检查条件：
- 是否启用自动生成？
- 是否已过触发时间（6:00）？
- 今天是否已生成？
   ↓
满足条件 → 自动生成日程
```

---

## 💡 使用建议

### 1. **日程时间设置**
- 根据实际作息调整 `wake_up_time` 和 `sleep_time`
- 三餐时间建议分散，避免冲突

### 2. **活动类型**
插件支持以下活动类型：
- `daily_routine` - 日常作息（起床、睡觉）
- `meal` - 吃饭
- `study` - 学习
- `entertainment` - 娱乐
- `social_maintenance` - 社交
- `exercise` - 运动
- `learn_topic` - 兴趣学习
- `custom` - 自定义

### 3. **个性化调整**
修改 `favorite_activities` 和 `learning_topics` 让日程更符合你的需求

### 4. **与麦麦对话**
- 在日程时间段内和麦麦聊天
- 麦麦会自然提到："这会儿正在吃饭" "等下要去学习"
- 回复风格会根据当前活动调整

---

## 🔧 性能优化

### 已实现的优化

1. **批量创建目标**
   - 10个日程项从10次磁盘写入优化为1次
   - 性能提升 90%+

2. **日程缓存**
   - 感知系统缓存60秒
   - 减少重复数据库查询

3. **历史记录清理**
   - 自动清理30天前的记录
   - 避免文件无限膨胀

---

## ❓ 常见问题

### Q: 为什么生成的日程没有保存？
A: 已修复。现在 `auto_apply` 默认为 `true`，日程会自动保存。

### Q: 如何修改日程内容？
A: 编辑 `config.toml` 中的 `preferences` 部分，然后重新生成日程。

### Q: 日程可以手动删除吗？
A: 可以。使用 `/plan list` 查看序号，然后 `/plan delete <序号>`。

### Q: 日程会自动更新吗？
A: 会。每天早上6点后，插件会自动删除旧日程并生成新的。

### Q: 如何禁用自动生成？
A: 在 `config.toml` 中设置 `auto_generate_daily = false`。

---

## 📊 数据说明

### goals.json
存储当前活跃的日程目标

```json
[
  {
    "goal_id": "uuid",
    "name": "起床",
    "description": "周末多睡会儿，自然醒",
    "goal_type": "daily_routine",
    "status": "active",
    "parameters": {
      "time_window": [7, 8]  // 7:00-8:00
    },
    "interval_seconds": 86400  // 24小时
  }
]
```

### schedule_history.json
存储生成历史（最近30天）

```json
{
  "daily": "2025-11-08",
  "generated_schedules": [
    {
      "type": "daily",
      "date": "2025-11-08",
      "schedule_name": "每日计划 - 2025-11-08",
      "goals_created": 10,
      "goal_ids": ["uuid1", "uuid2", ...]
    }
  ]
}
```

---

## 🎨 日程示例

根据麦麦的人格（女大学生，读大二，会刷贴吧），生成的日程示例：

```
07:30-08:30  起床      周末多睡会儿，自然醒
08:30-09:30  早饭      随便啃个面包，喝点牛奶
10:00-11:00  看番      补下新番，顺便刷下贴吧
11:30-12:30  学点东西  摸鱼学会儿Python，写两行代码
12:30-13:30  午饭      点个外卖，省事
14:00-16:00  打游戏    开两把游戏，放松一下
16:00-17:00  出门走走  溜达一圈，买杯奶茶
18:00-19:00  晚饭      食堂随便吃点
19:30-22:00  刷视频    刷刷B站，看看有啥好玩的
23:30-       睡觉      躺床上玩手机，困了就睡
```

---

## 🔄 版本信息

**当前版本**：2.1.0

**主要特性**：
- ✅ LLM 个性化日程生成
- ✅ 自动日程管理
- ✅ 感知系统集成
- ✅ 批量操作性能优化
- ✅ 人格风格适配

---

## 📞 支持

遇到问题？
1. 检查配置文件格式是否正确
2. 查看日志：`/home/ubuntu/maimai/MaiBot/logs/`
3. 使用 `/plan help` 查看命令帮助

---

**享受麦麦的个性化日程吧！** 🎉
